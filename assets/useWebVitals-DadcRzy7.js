import{r as pt}from"./react-DUjjZIqU.js";import{W as O}from"./index-BYW5WKQq.js";var F,et=-1,E=function(t){addEventListener("pageshow",function(n){n.persisted&&(et=n.timeStamp,t(n))},!0)},_=function(){var t=self.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0];if(t&&t.responseStart>0&&t.responseStart<performance.now())return t},M=function(){var t=_();return t&&t.activationStart||0},m=function(t,n){var e=_(),a="navigate";return et>=0?a="back-forward-cache":e&&(document.prerendering||M()>0?a="prerender":document.wasDiscarded?a="restore":e.type&&(a=e.type.replace(/_/g,"-"))),{name:t,value:n===void 0?-1:n,rating:"good",delta:0,entries:[],id:"v4-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:a}},b=function(t,n,e){try{if(PerformanceObserver.supportedEntryTypes.includes(t)){var a=new PerformanceObserver(function(o){Promise.resolve().then(function(){n(o.getEntries())})});return a.observe(Object.assign({type:t,buffered:!0},e||{})),a}}catch{}},g=function(t,n,e,a){var o,i;return function(s){n.value>=0&&(s||a)&&((i=n.value-(o||0))||o===void 0)&&(o=n.value,n.delta=i,n.rating=function(d,l){return d>l[1]?"poor":d>l[0]?"needs-improvement":"good"}(n.value,e),t(n))}},R=function(t){requestAnimationFrame(function(){return requestAnimationFrame(function(){return t()})})},P=function(t){document.addEventListener("visibilitychange",function(){document.visibilityState==="hidden"&&t()})},V=function(t){var n=!1;return function(){n||(t(),n=!0)}},y=-1,J=function(){return document.visibilityState!=="hidden"||document.prerendering?1/0:0},k=function(t){document.visibilityState==="hidden"&&y>-1&&(y=t.type==="visibilitychange"?t.timeStamp:0,ft())},z=function(){addEventListener("visibilitychange",k,!0),addEventListener("prerenderingchange",k,!0)},ft=function(){removeEventListener("visibilitychange",k,!0),removeEventListener("prerenderingchange",k,!0)},ot=function(){return y<0&&(y=J(),z(),E(function(){setTimeout(function(){y=J(),z()},0)})),{get firstHiddenTime(){return y}}},I=function(t){document.prerendering?addEventListener("prerenderingchange",function(){return t()},!0):t()},Q=[1800,3e3],rt=function(t,n){n=n||{},I(function(){var e,a=ot(),o=m("FCP"),i=b("paint",function(s){s.forEach(function(d){d.name==="first-contentful-paint"&&(i.disconnect(),d.startTime<a.firstHiddenTime&&(o.value=Math.max(d.startTime-M(),0),o.entries.push(d),e(!0)))})});i&&(e=g(t,o,Q,n.reportAllChanges),E(function(s){o=m("FCP"),e=g(t,o,Q,n.reportAllChanges),R(function(){o.value=performance.now()-s.timeStamp,e(!0)})}))})},G=[.1,.25],vt=function(t,n){n=n||{},rt(V(function(){var e,a=m("CLS",0),o=0,i=[],s=function(l){l.forEach(function(p){if(!p.hadRecentInput){var h=i[0],S=i[i.length-1];o&&p.startTime-S.startTime<1e3&&p.startTime-h.startTime<5e3?(o+=p.value,i.push(p)):(o=p.value,i=[p])}}),o>a.value&&(a.value=o,a.entries=i,e())},d=b("layout-shift",s);d&&(e=g(t,a,G,n.reportAllChanges),P(function(){s(d.takeRecords()),e(!0)}),E(function(){o=0,a=m("CLS",0),e=g(t,a,G,n.reportAllChanges),R(function(){return e()})}),setTimeout(e,0))}))},at=0,A=1/0,C=0,mt=function(t){t.forEach(function(n){n.interactionId&&(A=Math.min(A,n.interactionId),C=Math.max(C,n.interactionId),at=C?(C-A)/7+1:0)})},it=function(){return F?at:performance.interactionCount||0},gt=function(){"interactionCount"in performance||F||(F=b("event",mt,{type:"event",buffered:!0,durationThreshold:0}))},v=[],L=new Map,st=0,ht=function(){var t=Math.min(v.length-1,Math.floor((it()-st)/50));return v[t]},St=[],yt=function(t){if(St.forEach(function(o){return o(t)}),t.interactionId||t.entryType==="first-input"){var n=v[v.length-1],e=L.get(t.interactionId);if(e||v.length<10||t.duration>n.latency){if(e)t.duration>e.latency?(e.entries=[t],e.latency=t.duration):t.duration===e.latency&&t.startTime===e.entries[0].startTime&&e.entries.push(t);else{var a={id:t.interactionId,latency:t.duration,entries:[t]};L.set(a.id,a),v.push(a)}v.sort(function(o,i){return i.latency-o.latency}),v.length>10&&v.splice(10).forEach(function(o){return L.delete(o.id)})}}},ct=function(t){var n=self.requestIdleCallback||self.setTimeout,e=-1;return t=V(t),document.visibilityState==="hidden"?t():(e=n(t),P(t)),e},K=[200,500],Et=function(t,n){"PerformanceEventTiming"in self&&"interactionId"in PerformanceEventTiming.prototype&&(n=n||{},I(function(){var e;gt();var a,o=m("INP"),i=function(d){ct(function(){d.forEach(yt);var l=ht();l&&l.latency!==o.value&&(o.value=l.latency,o.entries=l.entries,a())})},s=b("event",i,{durationThreshold:(e=n.durationThreshold)!==null&&e!==void 0?e:40});a=g(t,o,K,n.reportAllChanges),s&&(s.observe({type:"first-input",buffered:!0}),P(function(){i(s.takeRecords()),a(!0)}),E(function(){st=it(),v.length=0,L.clear(),o=m("INP"),a=g(t,o,K,n.reportAllChanges)}))}))},X=[2500,4e3],q={},bt=function(t,n){n=n||{},I(function(){var e,a=ot(),o=m("LCP"),i=function(l){n.reportAllChanges||(l=l.slice(-1)),l.forEach(function(p){p.startTime<a.firstHiddenTime&&(o.value=Math.max(p.startTime-M(),0),o.entries=[p],e())})},s=b("largest-contentful-paint",i);if(s){e=g(t,o,X,n.reportAllChanges);var d=V(function(){q[o.id]||(i(s.takeRecords()),s.disconnect(),q[o.id]=!0,e(!0))});["keydown","click"].forEach(function(l){addEventListener(l,function(){return ct(d)},{once:!0,capture:!0})}),P(d),E(function(l){o=m("LCP"),e=g(t,o,X,n.reportAllChanges),R(function(){o.value=performance.now()-l.timeStamp,q[o.id]=!0,e(!0)})})}})},Y=[800,1800],Tt=function t(n){document.prerendering?I(function(){return t(n)}):document.readyState!=="complete"?addEventListener("load",function(){return t(n)},!0):setTimeout(n,0)},wt=function(t,n){n=n||{};var e=m("TTFB"),a=g(t,e,Y,n.reportAllChanges);Tt(function(){var o=_();o&&(e.value=Math.max(o.responseStart-M(),0),e.entries=[o],a(!0),E(function(){e=m("TTFB",0),(a=g(t,e,Y,n.reportAllChanges))(!0)}))})};const f=[];for(let t=0;t<256;++t)f.push((t+256).toString(16).slice(1));function Ct(t,n=0){return(f[t[n+0]]+f[t[n+1]]+f[t[n+2]]+f[t[n+3]]+"-"+f[t[n+4]]+f[t[n+5]]+"-"+f[t[n+6]]+f[t[n+7]]+"-"+f[t[n+8]]+f[t[n+9]]+"-"+f[t[n+10]]+f[t[n+11]]+f[t[n+12]]+f[t[n+13]]+f[t[n+14]]+f[t[n+15]]).toLowerCase()}let D;const Lt=new Uint8Array(16);function kt(){if(!D){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");D=crypto.getRandomValues.bind(crypto)}return D(Lt)}const Mt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Z={randomUUID:Mt};function x(t,n,e){var o;if(Z.randomUUID&&!t)return Z.randomUUID();t=t||{};const a=t.random??((o=t.rng)==null?void 0:o.call(t))??kt();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,Ct(a)}const tt=window.location,B=tt.protocol+"//"+tt.host,Pt=B+"/loki/api/v1/push",It=B+"/influx/api/v2/write",Nt=B+"/tempo/api/push",nt={CLS:"Cumulative Layout Shift",FID:"First Input Delay",FCP:"First Contentful Paint",INP:"Interaction to Next Paint",LCP:"Largest Contentful Paint",TTFB:"Time to First Byte"};function ut(t){const n=new Map;for(const a of t){const o=JSON.stringify(a);n.set(o,(n.get(o)||0)+1)}const e=[];for(const[a,o]of n.entries()){const s={...JSON.parse(a),count:o};e.push(s)}return e}const At=t=>t.map(n=>`${n.metric.name},page=${n.page},rating=${n.metric.rating||"unknown"} value=${n.metric.value} ${Date.now()*1e6}`).join(`
`),qt=async t=>{try{await fetch(It,{method:"POST",headers:{"Content-Type":"text/plain"},body:t})}catch(n){throw console.error("Failed to push metrics:",n),n}},Dt=async t=>{try{await fetch(Pt,{method:"POST",headers:{"Content-Type":"application/json"},body:t})}catch(n){throw console.error("Failed to push logs:",n),n}},Ft=async(t,n)=>{const e=await t.map(async({metric:o,page:i,traceId:s})=>{var p,h;let d=o.entries;o.name==="INP"&&(d=ut(o.entries));const l=`job=WebVitals name=${o.name} description="${nt[o.name]}" traceId=${s} instance=${n} page="${i}" value=${o.value} rating=${o.rating||"unknown"} delta=${((p=o.delta)==null?void 0:p.toString())||"N/A"} entries=${JSON.stringify(d||[])}`;return{stream:{level:"info",job:"webVitals",name:o.name,metricName:o.name,metricLabel:"page",instance:n,description:nt[o.name],value:o.value.toString(),rating:o.rating||"unknown",delta:((h=o.delta)==null?void 0:h.toString())||"N/A",traceId:s,page:i,hasMetrics:!0},values:[[String(Date.now()*1e6),l]]}}),a=await Promise.all(e);return JSON.stringify(a?{streams:a}:{streams:[]})},xt=(t,n)=>t.map(({metric:e,page:a,traceId:o})=>({metric:e,page:a,traceId:o,instance:n})),Ot=(t,n,e,a)=>{var W,U,j,H;const o=Math.floor(Date.now()*1e3),i=x().replace(/-/g,""),s=(r,u,N,c,T,w)=>({id:x().replace(/-/g,""),traceId:N,parentId:c,name:r,timestamp:Math.floor(Date.now()*1e3)+Math.floor(T*1e3),duration:Math.floor(u*1e3),tags:{"web.vital.event":r,"web.vital.page":n,"web.vital.name":t.name,"web.vital.description":t.description,"qryn-view.instance":t.instance,...w},localEndpoint:{serviceName:r}}),d=(r,u)=>{var T,w;const N=Math.floor(Date.now()*1e3),c=(T=r.entries)==null?void 0:T[0];return{id:i,traceId:e,timestamp:N,duration:Math.floor(c.duration*1e3),name:"TTFB",tags:{"http.method":"GET","http.path":u,"web.vital.name":"TTFB","web.vital.description":r.description,"web.vital.value":r.value.toString(),"web.vital.rating":r.rating||"unknown","web.vital.delta":((w=r.delta)==null?void 0:w.toString())||"N/A","ttfb.fetch_time":(c.fetchStart-c.navigationStart).toString(),"ttfb.dns_time":(c.domainLookupEnd-c.domainLookupStart).toString(),"ttfb.connect_time":(c.connectEnd-c.connectStart).toString(),"ttfb.request_time":(c.responseStart-c.requestStart).toString(),"ttfb.response_time":(c.responseEnd-c.responseStart).toString(),"http.response_content_length":c.encodedBodySize.toString(),"http.response_transfer_size":c.transferSize.toString(),"http.response_decoded_content_length":c.decodedBodySize.toString(),"http.status_code":c.responseStatus.toString(),"network.protocol.name":c.nextHopProtocol||"unknown","network.protocol.version":c.nextHopProtocol?c.nextHopProtocol.split("/")[1]:"unknown","ttfb.initiatorType":c.initiatorType,"ttfb.deliveryType":c.deliveryType,"ttfb.renderBlockingStatus":c.renderBlockingStatus,"ttfb.workerStart":c.workerStart.toString(),"ttfb.redirectCount":c.redirectCount.toString(),"performance.domInteractive":c.domInteractive.toString(),"performance.domContentLoadedEvent":(c.domContentLoadedEventEnd-c.domContentLoadedEventStart).toString(),"performance.loadEvent":(c.loadEventEnd-c.loadEventStart).toString(),"qryn-view.instance":a},localEndpoint:{serviceName:"Web Vitals"}}},l=(r,u)=>({id:i,traceId:e,timestamp:o,duration:Math.floor(r.value*1e3),name:"INP",tags:{"http.method":"GET","inp.name":r.name,"inp.page":u,"inp.value":r.value,"inp.rating":r.rating,"inp.delta":r.delta,"qryn-view.instance":a},localEndpoint:{serviceName:"Web Vitals"}});let p={id:i,traceId:e,timestamp:o,duration:Math.floor(t.value*1e3),name:t.name,localEndpoint:{serviceName:"Web Vitals"}},h={"http.method":"GET","http.path":n,"web.vital.name":t.name,"web.vital.description":t.description,"web.vital.value":t.value.toString(),"web.vital.rating":t.rating||"unknown","web.vital.delta":((W=t.delta)==null?void 0:W.toString())||"N/A","qryn-view.instance":a};p.tags=h;let S=[];if(t.name==="TTFB"){p=d(t,n);const r=(U=t.entries)==null?void 0:U[0];if(r){const u=r.startTime;S=[s("Navigation Start",r.startTime,e,i,r.startTime,{"ttfb.startTime":r.startTime}),s("Fetch Start",r.fetchStart,e,i,r.fetchStart,{"ttfb.fetchStart":r.fetchStart}),s("Domain Lookup",r.domainLookupEnd-r.domainLookupStart,e,i,r.domainLookupStart-u,{"ttfb.domainLookupStart":r.domainLookupStart,"ttfb.domainLookupEnd":r.domainLookupEnd}),s("Connect",r.connectEnd-r.connectStart,e,i,r.connectStart-u,{"ttfb.connectStart":r.connectStart,"ttfb.connectEnd":r.connectEnd}),s("Request/Response",r.responseEnd-r.requestStart,e,i,r.requestStart-u,{"ttfb.requestStart":r.requestStart,"ttfb.requestEnd":r.requestEnd}),s("Unload Event",r.unloadEventEnd-r.unloadEventStart,e,i,r.unloadEventStart-u,{"ttfb.unloadEventStart":r.unloadEventStart,"ttfb.unloadEventEnd":r.unloadEventEnd}),s("DOM Interactive",0,e,i,r.domInteractive-u,{"ttfb.domInteractive":r.domInteractive}),s("DOM Content Loaded",r.domContentLoadedEventEnd-r.domContentLoadedEventStart,e,i,r.domContentLoadedEventStart-u,{"ttfb.domContentLoadedEventStart":r.domContentLoadedEventStart,"ttfb.domContentLoadedEventEnd":r.domContentLoadedEventEnd}),s("DOM Complete",0,e,i,r.domComplete-u,{"ttfb.domComplete":r.domComplete}),s("Load Event",r.loadEventEnd-r.loadEventStart,e,i,r.loadEventStart-u,{"ttfb.loadEventStart":r.loadEventStart,"ttfb.loadEventEnd":r.loadEventEnd})]}}if(t.name==="INP"){p=l(t,n);const r=(j=ut(t.entries))==null?void 0:j.map(u=>s(u.name,Math.round(u.processingEnd-u.processingStart),e,i,Math.round(u.processingStart),{"inp.name":u.name,"inp.interactionId":u.interactionId,"inp.startTime":u.startTime,"inp.processingStart":u.processingStart,"inp.processingEnd":u.processingEnd,"inp.cancellable":u.cancelable,"inp.count":u.count,"qryn-view.instance":a}));(r==null?void 0:r.length)>0&&(S=r)}let $=[p];return((H=Object.keys(S))==null?void 0:H.length)>0&&($=[p,...S]),$},_t=async t=>{try{await fetch(Nt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(n){console.error("Error sending trace data:",n)}};async function dt(t){if(t.size!==0)try{const{qrynInstance:n}=O.getState(),e=Array.from(t),a=await Ft(e,n).then(d=>d),o=xt(e,n),i=At(o),s=e.flatMap(({metric:d,page:l,traceId:p,instance:h})=>Ot(d,l,p,h));await Promise.all([qt(i),Dt(a),_t(s)]),t.clear()}catch(n){console.error("Error flushing queue:",n)}}const lt=async t=>{document.visibilityState==="hidden"&&await dt(t)},Rt=(t,n)=>{const{qrynInstance:e}=O.getState(),a=async o=>{const i=x().replace(/-/g,"");t.add({metric:o,page:n,traceId:i,instance:e})};vt(a),rt(a),Et(a),bt(a),wt(a),addEventListener("visibilitychange",()=>lt(t))},$t=({page:t})=>{const{webVitalsActive:n}=O();pt.useEffect(()=>{const e=new Set;return n&&Rt(e,t),()=>{n&&(document.removeEventListener("visibilitychange",()=>lt(e)),dt(e))}},[])};export{Pt as L,It as M,Nt as T,$t as u,x as v};
